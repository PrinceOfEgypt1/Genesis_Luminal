import type { AIProvider } from './AIProvider';
import type { EmotionalAnalysisRequest, EmotionalAnalysisResponse } from '../../../shared/types/api';
import { env, apiKey } from '../config/env';

export class AnthropicProvider implements AIProvider {
  name = 'anthropic';

  async analyze(input: EmotionalAnalysisRequest): Promise<EmotionalAnalysisResponse> {
    const key = apiKey();
    if (!key) {
      const err: any = new Error('MISSING_API_KEY');
      err.code = 'MISSING_API_KEY';
      throw err;
    }

    // Payload simples — ajuste conforme seu prompt/modelo reais
    const body = {
      model: 'claude-3-5-sonnet-latest',
      max_tokens: 256,
      messages: [
        { role: 'user', content: `Analise o estado emocional do texto: "${input.text}"` }
      ]
    };

    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'content-type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      const err: any = new Error(`${res.status} ${res.statusText}`);
      err.code = (data?.error?.type) || `HTTP_${res.status}`;
      err.details = data;
      throw err;
    }

    // Mapeie a resposta real aqui; por ora, devolvemos uma forma canônica:
    // Em contexto de demo, trate como "neutro" com confiança média.
    const now = new Date().toISOString();
    return {
      intensity: 0.5,
      dominantAffect: 'neutral',
      timestamp: now,
      confidence: 0.6,
      recommendation: 'continue',
      emotionalShift: 'stable',
      morphogenicSuggestion: 'fibonacci',
    };
  }
}
